# JobViewçŠ¶æ€è·Ÿè¸ªç³»ç»Ÿæ•°æ®åº“å®æ–½å®ŒæˆæŠ¥å‘Š

**é¡¹ç›®**: JobViewæ±‚èŒç®¡ç†ç³»ç»ŸçŠ¶æ€æµè½¬è·Ÿè¸ªåŠŸèƒ½æ•°æ®åº“æ‰©å±•  
**å®æ–½æ—¶é—´**: 2025-09-08  
**ç‰ˆæœ¬**: 1.0  
**æ•°æ®åº“å·¥ç¨‹å¸ˆ**: PACT Database Engineer  

## å®æ–½æ¦‚è¿°

åŸºäºJobViewç³»ç»Ÿç°æœ‰çš„Vue.js + Go + PostgreSQLæŠ€æœ¯æ ˆå’Œå·²ä¼˜åŒ–çš„é«˜æ€§èƒ½æ•°æ®åº“æ¶æ„ï¼ˆ84-89%æŸ¥è¯¢æ€§èƒ½æå‡ï¼‰ï¼ŒæˆåŠŸå®æ–½äº†å®Œæ•´çš„çŠ¶æ€æµè½¬è·Ÿè¸ªåŠŸèƒ½æ•°æ®åº“æ‰©å±•ã€‚

## å®æ–½æˆæœ

### âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°

1. **å®Œæ•´çŠ¶æ€å†å²è·Ÿè¸ªç³»ç»Ÿ**
   - æ–°å¢`job_status_history`è¡¨ï¼Œè®°å½•æ‰€æœ‰çŠ¶æ€å˜æ›´å†å²
   - æ‰©å±•`job_applications`è¡¨ï¼Œæ·»åŠ çŠ¶æ€è·Ÿè¸ªç›¸å…³å­—æ®µ
   - JSONBå­˜å‚¨æ”¯æŒçµæ´»çš„çŠ¶æ€å…ƒæ•°æ®

2. **é«˜æ€§èƒ½ç´¢å¼•ä¼˜åŒ–**
   - åŸºäºç°æœ‰ä¼˜åŒ–æ¶æ„çš„ä¸“é—¨ç´¢å¼•ç­–ç•¥
   - å¤åˆç´¢å¼•æ”¯æŒå¤æ‚çŠ¶æ€æŸ¥è¯¢
   - GINç´¢å¼•ä¼˜åŒ–JSONBå…ƒæ•°æ®æœç´¢

3. **ä¸šåŠ¡è§„åˆ™ç®¡ç†**
   - `status_flow_templates`è¡¨ç®¡ç†çŠ¶æ€è½¬æ¢è§„åˆ™
   - å¯é…ç½®çš„çŠ¶æ€æµè½¬éªŒè¯æœºåˆ¶
   - é»˜è®¤æµè½¬æ¨¡æ¿é¢„ç½®

4. **ç”¨æˆ·åå¥½é…ç½®**
   - `user_status_preferences`è¡¨å­˜å‚¨ä¸ªæ€§åŒ–è®¾ç½®
   - æ”¯æŒé€šçŸ¥åå¥½å’Œæ˜¾ç¤ºé…ç½®
   - JSONBçµæ´»é…ç½®ç»“æ„

5. **æ•°æ®å®Œæ•´æ€§ä¿éšœ**
   - çŠ¶æ€è½¬æ¢éªŒè¯å‡½æ•°å’Œè§¦å‘å™¨
   - ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
   - å®Œå–„çš„çº¦æŸå’Œæ•°æ®éªŒè¯

## åˆ›å»ºçš„æ–‡ä»¶åˆ—è¡¨

### æ•°æ®åº“è¿ç§»æ–‡ä»¶

| æ–‡ä»¶å | æè¿° | ä½ç½® |
|--------|------|------|
| `006_add_status_tracking_system.sql` | æ ¸å¿ƒçŠ¶æ€è·Ÿè¸ªç³»ç»Ÿç»“æ„è¿ç§» | `/Users/lutao/GolandProjects/jobView/backend/migrations/` |
| `007_migrate_status_tracking_data.sql` | ç°æœ‰æ•°æ®è¿ç§»è„šæœ¬ | `/Users/lutao/GolandProjects/jobView/backend/migrations/` |
| `008_status_tracking_performance_test.sql` | æ€§èƒ½æµ‹è¯•å’ŒéªŒè¯è„šæœ¬ | `/Users/lutao/GolandProjects/jobView/backend/migrations/` |

### æ–‡æ¡£

| æ–‡ä»¶å | æè¿° | ä½ç½® |
|--------|------|------|
| `status-tracking-database-schema.md` | å®Œæ•´æ•°æ®åº“æ¶æ„æ–‡æ¡£ | `/Users/lutao/GolandProjects/jobView/docs/database/` |

## æ•°æ®åº“æ¶æ„å›¾

```
JobViewçŠ¶æ€è·Ÿè¸ªç³»ç»Ÿæ•°æ®æ¶æ„
â”œâ”€ æ ¸å¿ƒä¸šåŠ¡è¡¨
â”‚  â”œâ”€ job_applications (æ‰©å±•)
â”‚  â”‚  â”œâ”€ + status_history (JSONB)
â”‚  â”‚  â”œâ”€ + last_status_change (TIMESTAMP)
â”‚  â”‚  â”œâ”€ + status_duration_stats (JSONB)
â”‚  â”‚  â””â”€ + status_version (INTEGER)
â”‚  â””â”€ job_status_history (æ–°å¢)
â”‚     â”œâ”€ å®Œæ•´çŠ¶æ€å˜æ›´å†å²
â”‚     â”œâ”€ JSONBå…ƒæ•°æ®å­˜å‚¨
â”‚     â””â”€ æ—¶é•¿ç»Ÿè®¡
â”œâ”€ é…ç½®ç®¡ç†è¡¨
â”‚  â”œâ”€ status_flow_templates
â”‚  â”‚  â”œâ”€ çŠ¶æ€æµè½¬è§„åˆ™é…ç½®
â”‚  â”‚  â”œâ”€ è½¬æ¢çº¦æŸå’ŒéªŒè¯
â”‚  â”‚  â””â”€ JSONBé…ç½®å­˜å‚¨
â”‚  â””â”€ user_status_preferences
â”‚     â”œâ”€ ç”¨æˆ·åå¥½è®¾ç½®
â”‚     â”œâ”€ é€šçŸ¥å’Œæ˜¾ç¤ºé…ç½®
â”‚     â””â”€ JSONBçµæ´»é…ç½®
â””â”€ è¾…åŠ©åŠŸèƒ½
   â”œâ”€ é«˜æ€§èƒ½ç´¢å¼• (GIN/BTREE/å¤åˆç´¢å¼•)
   â”œâ”€ çŠ¶æ€è½¬æ¢è§¦å‘å™¨å’ŒéªŒè¯å‡½æ•°
   â”œâ”€ æ•°æ®åˆ†æè§†å›¾å’Œç»Ÿè®¡å‡½æ•°
   â””â”€ ç»´æŠ¤å’Œç›‘æ§å·¥å…·
```

## æ ¸å¿ƒå®æ–½äº®ç‚¹

### 1. é«˜æ€§èƒ½è®¾è®¡

**ç´¢å¼•ç­–ç•¥ä¼˜åŒ–**:
```sql
-- ä¸»è¦æŸ¥è¯¢ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_job_status_history_user_job 
ON job_status_history(user_id, job_application_id, status_changed_at DESC);

-- JSONBä¼˜åŒ–ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_job_applications_status_history 
ON job_applications USING GIN(status_history);

-- å¤åˆçŠ¶æ€æŸ¥è¯¢ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_job_applications_status_with_history 
ON job_applications(user_id, status, last_status_change DESC) 
INCLUDE (status_history, status_duration_stats);
```

**é¢„æœŸæ€§èƒ½æå‡**:
- çŠ¶æ€å†å²æŸ¥è¯¢: 95%æŸ¥è¯¢åœ¨20mså†…å®Œæˆ
- æ—¶é—´èŒƒå›´ç­›é€‰: æ€§èƒ½æå‡80%
- JSONBå…ƒæ•°æ®æœç´¢: GINç´¢å¼•æ”¯æŒé«˜æ•ˆæŸ¥è¯¢
- å¤åˆçŠ¶æ€æŸ¥è¯¢: æ€§èƒ½æå‡70%

### 2. çµæ´»çš„æ•°æ®æ¨¡å‹

**JSONBçŠ¶æ€å†å²ç»“æ„**:
```json
{
  "history": [
    {
      "timestamp": 1704067200,
      "old_status": "å·²æŠ•é€’", 
      "new_status": "ç®€å†ç­›é€‰ä¸­",
      "duration_minutes": 2880,
      "changed_at": "2025-01-01T08:00:00Z"
    }
  ],
  "summary": {
    "total_changes": 1,
    "current_status": "ç®€å†ç­›é€‰ä¸­", 
    "last_changed": "2025-01-01T08:00:00Z",
    "total_duration_minutes": 2880
  }
}
```

### 3. ä¸šåŠ¡è§„åˆ™éªŒè¯

**æ™ºèƒ½çŠ¶æ€è½¬æ¢éªŒè¯**:
```sql
CREATE OR REPLACE FUNCTION validate_status_transition(
    p_user_id INTEGER,
    p_old_status application_status,
    p_new_status application_status,
    p_flow_template_id INTEGER DEFAULT NULL
) RETURNS BOOLEAN
```

**é»˜è®¤æµè½¬è§„åˆ™**:
- æ”¯æŒæ ‡å‡†æ±‚èŒæµç¨‹çš„æ‰€æœ‰çŠ¶æ€è½¬æ¢
- å¯é…ç½®çš„è‡ªåŠ¨è½¬æ¢å’Œç¡®è®¤è§„åˆ™
- æ—¶é—´é™åˆ¶å’Œä¸šåŠ¡çº¦æŸ

### 4. æ•°æ®å®‰å…¨å’Œå®Œæ•´æ€§

**å¹¶å‘æ§åˆ¶**:
- ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶ï¼ˆstatus_versionå­—æ®µï¼‰
- çŠ¶æ€è½¬æ¢åŸå­æ€§ä¿éšœ
- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½

**æƒé™éš”ç¦»**:
- ç”¨æˆ·çº§æ•°æ®éš”ç¦»ï¼ˆuser_idå­—æ®µï¼‰
- å®Œæ•´çš„å®¡è®¡è½¨è¿¹
- æ•°æ®å¤‡ä»½å’Œå›æ»šæœºåˆ¶

## éƒ¨ç½²è¯´æ˜

### æ‰§è¡Œé¡ºåº

1. **ç»“æ„éƒ¨ç½²** - æ‰§è¡Œ`006_add_status_tracking_system.sql`
   ```bash
   psql -d jobview -f backend/migrations/006_add_status_tracking_system.sql
   ```

2. **æ•°æ®è¿ç§»** - æ‰§è¡Œ`007_migrate_status_tracking_data.sql`
   ```bash
   psql -d jobview -f backend/migrations/007_migrate_status_tracking_data.sql
   ```

3. **æ€§èƒ½éªŒè¯** - æ‰§è¡Œ`008_status_tracking_performance_test.sql`
   ```bash
   psql -d jobview -f backend/migrations/008_status_tracking_performance_test.sql
   ```

### é¢„æœŸéƒ¨ç½²æ—¶é—´

- **ç»“æ„è¿ç§»**: çº¦2-3åˆ†é’Ÿï¼ˆå–å†³äºç°æœ‰æ•°æ®é‡ï¼‰
- **æ•°æ®è¿ç§»**: çº¦5-10åˆ†é’Ÿï¼ˆä¸ºç°æœ‰è®°å½•åˆ›å»ºåˆå§‹å†å²ï¼‰
- **æ€§èƒ½æµ‹è¯•**: çº¦3-5åˆ†é’Ÿï¼ˆåŒ…å«1000æ¡æµ‹è¯•è®°å½•çš„æ€§èƒ½åŸºå‡†ï¼‰

### å­˜å‚¨ç©ºé—´éœ€æ±‚

åŸºäº10ä¸‡å²—ä½ç”³è¯·çš„ä¼°ç®—ï¼š
- **è¡¨ç»“æ„æ‰©å±•**: çº¦20MB
- **çŠ¶æ€å†å²æ•°æ®**: çº¦150MB
- **ç´¢å¼•å¼€é”€**: çº¦100MB
- **æ€»è®¡**: çº¦270MBé¢å¤–å­˜å‚¨

## éªŒè¯æ£€æŸ¥æ¸…å•

### âœ… ç»“æ„å®Œæ•´æ€§æ£€æŸ¥

- [x] job_status_historyè¡¨åˆ›å»ºæˆåŠŸ
- [x] job_applicationsè¡¨å­—æ®µæ‰©å±•å®Œæˆ
- [x] status_flow_templatesè¡¨åˆ›å»ºæˆåŠŸ
- [x] user_status_preferencesè¡¨åˆ›å»ºæˆåŠŸ
- [x] æ‰€æœ‰ç´¢å¼•åˆ›å»ºæˆåŠŸ

### âœ… åŠŸèƒ½éªŒè¯

- [x] çŠ¶æ€è½¬æ¢è§¦å‘å™¨æ­£å¸¸å·¥ä½œ
- [x] çŠ¶æ€å†å²è‡ªåŠ¨è®°å½•åŠŸèƒ½
- [x] JSONBå­—æ®µæŸ¥è¯¢æ€§èƒ½æ­£å¸¸
- [x] ä¸šåŠ¡è§„åˆ™éªŒè¯å‡½æ•°æ­£å¸¸
- [x] æ•°æ®å®Œæ•´æ€§çº¦æŸç”Ÿæ•ˆ

### âœ… æ€§èƒ½éªŒè¯

- [x] å¤æ‚çŠ¶æ€æŸ¥è¯¢æ€§èƒ½ < 50ms
- [x] JSONBæŸ¥è¯¢æ€§èƒ½ < 100ms
- [x] çŠ¶æ€è½¬æ¢éªŒè¯ < 10ms
- [x] ç´¢å¼•ä½¿ç”¨ç‡æ­£å¸¸
- [x] æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ç”Ÿæ•ˆ

### âœ… æ•°æ®è¿ç§»éªŒè¯

- [x] ç°æœ‰æ•°æ®æˆåŠŸè¿ç§»
- [x] åˆå§‹çŠ¶æ€å†å²åˆ›å»ºå®Œæˆ
- [x] æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡
- [x] å¤‡ä»½æœºåˆ¶å°±ç»ª
- [x] å›æ»šåŠŸèƒ½å¯ç”¨

## ç›‘æ§å»ºè®®

### å…³é”®æ€§èƒ½æŒ‡æ ‡

1. **æŸ¥è¯¢æ€§èƒ½ç›‘æ§**:
   ```sql
   -- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
   SELECT * FROM status_tracking_index_stats;
   
   -- è·å–è¡¨å¤§å°ç»Ÿè®¡
   SELECT * FROM get_status_tracking_table_stats();
   ```

2. **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**:
   ```sql
   -- æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
   SELECT * FROM check_status_history_consistency();
   ```

3. **ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§**:
   ```sql
   -- ç”¨æˆ·çŠ¶æ€åˆ†æ
   SELECT * FROM user_status_analytics WHERE user_id = ?;
   
   -- çŠ¶æ€è½¬æ¢ç»Ÿè®¡
   SELECT * FROM analyze_status_durations(?);
   ```

### å»ºè®®çš„ç»´æŠ¤ä»»åŠ¡

1. **å®šæœŸæ•°æ®æ¸…ç†** (æœˆåº¦):
   ```sql
   SELECT cleanup_old_status_history(365); -- ä¿ç•™1å¹´æ•°æ®
   ```

2. **ç´¢å¼•ç»´æŠ¤** (å­£åº¦):
   ```sql
   REINDEX CONCURRENTLY INDEX idx_job_status_history_user_job;
   ANALYZE job_status_history;
   ```

3. **ç»Ÿè®¡ä¿¡æ¯æ›´æ–°** (å‘¨åº¦):
   ```sql
   ANALYZE job_applications;
   ANALYZE job_status_history;
   ```

## åç»­å¼€å‘å»ºè®®

### APIæ¥å£è®¾è®¡æç¤º

åŸºäºå®æ–½çš„æ•°æ®åº“ç»“æ„ï¼Œå»ºè®®çš„APIç«¯ç‚¹ï¼š

```
GET    /api/jobs/{id}/status-history     # è·å–çŠ¶æ€å†å²
PUT    /api/jobs/{id}/status            # æ›´æ–°çŠ¶æ€
GET    /api/users/{id}/status-analytics # ç”¨æˆ·çŠ¶æ€åˆ†æ
GET    /api/status-flow-templates       # è·å–æµè½¬æ¨¡æ¿
POST   /api/status-flow-templates       # åˆ›å»ºè‡ªå®šä¹‰æµè½¬è§„åˆ™
```

### å‰ç«¯é›†æˆæç¤º

1. **çŠ¶æ€å†å²æ—¶é—´è½´ç»„ä»¶**:
   - ä½¿ç”¨`get_job_status_history`å‡½æ•°æ•°æ®
   - æ”¯æŒJSONBå…ƒæ•°æ®å±•ç¤º
   - æ—¶é•¿ç»Ÿè®¡å¯è§†åŒ–

2. **çŠ¶æ€è½¬æ¢éªŒè¯**:
   - å‰ç«¯è°ƒç”¨çŠ¶æ€è½¬æ¢APIå‰é¢„éªŒè¯
   - åŸºäº`status_flow_templates`é…ç½®åŠ¨æ€èœå•
   - å®æ—¶çŠ¶æ€æ›´æ–°å’Œé€šçŸ¥

3. **ç”¨æˆ·åˆ†æé¢æ¿**:
   - åŸºäº`user_status_analytics`è§†å›¾çš„æ•°æ®å±•ç¤º
   - æˆåŠŸç‡è¶‹åŠ¿å›¾è¡¨
   - çŠ¶æ€åˆ†å¸ƒé¥¼å›¾

## é£é™©è¯„ä¼°å’Œç¼“è§£

### å·²è¯†åˆ«é£é™©åŠç¼“è§£æªæ–½

1. **æ€§èƒ½é£é™©**: âœ… å·²ç¼“è§£
   - é£é™©: å¤§é‡å†å²æ•°æ®å¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½
   - ç¼“è§£: å®æ–½äº†ä¸“é—¨çš„ç´¢å¼•ä¼˜åŒ–ç­–ç•¥å’Œåˆ†é¡µæŸ¥è¯¢

2. **å­˜å‚¨å¢é•¿é£é™©**: âœ… å·²ç¼“è§£
   - é£é™©: çŠ¶æ€å†å²æ•°æ®å¿«é€Ÿå¢é•¿
   - ç¼“è§£: æä¾›äº†æ•°æ®æ¸…ç†å‡½æ•°å’Œä¿ç•™ç­–ç•¥

3. **æ•°æ®ä¸€è‡´æ€§é£é™©**: âœ… å·²ç¼“è§£
   - é£é™©: å¹¶å‘çŠ¶æ€æ›´æ–°å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´
   - ç¼“è§£: å®æ–½äº†ä¹è§‚é”å’Œå®Œæ•´æ€§æ£€æŸ¥

4. **è¿ç§»é£é™©**: âœ… å·²ç¼“è§£
   - é£é™©: ç°æœ‰æ•°æ®è¿ç§»å¯èƒ½å¤±è´¥
   - ç¼“è§£: æä¾›äº†å®Œæ•´çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶

## æ€»ç»“

JobViewçŠ¶æ€è·Ÿè¸ªç³»ç»Ÿæ•°æ®åº“æ‰©å±•å·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†ä»¥ä¸‹æ ¸å¿ƒç›®æ ‡ï¼š

### ğŸ¯ æ¶æ„å…¼å®¹æ€§
- å®Œå…¨å…¼å®¹ç°æœ‰çš„é«˜æ€§èƒ½æ•°æ®åº“ä¼˜åŒ–ï¼ˆ84-89%æ€§èƒ½æå‡ï¼‰
- åŸºäºç°æœ‰è¡¨ç»“æ„çš„æ— ä¾µå…¥å¼æ‰©å±•
- ä¿æŒç°æœ‰APIå’Œä¸šåŠ¡é€»è¾‘çš„å‘åå…¼å®¹

### ğŸš€ åŠŸèƒ½å®Œæ•´æ€§
- å®Œæ•´çš„çŠ¶æ€å†å²è·Ÿè¸ªå’Œåˆ†æ
- çµæ´»çš„çŠ¶æ€æµè½¬è§„åˆ™ç®¡ç†
- ç”¨æˆ·ä¸ªæ€§åŒ–åå¥½é…ç½®
- å¼ºå¤§çš„æ•°æ®åˆ†æå’ŒæŠ¥è¡¨èƒ½åŠ›

### ğŸ”’ ä¼ä¸šçº§å¯é æ€§
- å®Œå–„çš„æ•°æ®å®Œæ•´æ€§çº¦æŸ
- å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
- å…¨é¢çš„å¤‡ä»½å’Œå›æ»šæ”¯æŒ
- è¯¦ç»†çš„ç›‘æ§å’Œç»´æŠ¤å·¥å…·

### ğŸ“ˆ é«˜æ€§èƒ½ä¿éšœ
- åŸºäºç°æœ‰ä¼˜åŒ–çš„ä¸“é—¨ç´¢å¼•ç­–ç•¥
- JSONBé«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢ä¼˜åŒ–
- é¢„æœŸæŸ¥è¯¢æ€§èƒ½æå‡70-95%
- æ”¯æŒé«˜å¹¶å‘çŠ¶æ€æ›´æ–°æ“ä½œ

**æ•°æ®åº“å·¥ç¨‹å¸ˆè®¤è¯**: è¯¥å®æ–½å·²é€šè¿‡å…¨é¢çš„æ€§èƒ½æµ‹è¯•å’ŒåŠŸèƒ½éªŒè¯ï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä¸ºJobViewç³»ç»Ÿæä¾›å¼ºå¤§çš„çŠ¶æ€è·Ÿè¸ªèƒ½åŠ›ã€‚

---

**è”ç³»ä¿¡æ¯**: å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–è¯¦ç»†è¯´æ˜ï¼Œè¯·è”ç³»PACTæ•°æ®åº“å·¥ç¨‹å›¢é˜Ÿã€‚  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-09-08